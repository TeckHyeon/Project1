<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="UTF-8">
<title>메인화면</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
	crossorigin="anonymous">
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
	integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
	crossorigin="anonymous"></script>
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<style type="text/css">
input {
	border: none;
}

.navbar-fixed-left {
	position: fixed;
	top: 0;
	left: 0;
	height: 100%;
	width: 220px;
	background-color: #333;
	overflow: auto;
	padding: 10px;
}

.content_text {
	overflow: hidden;
	display: -webkit-box;
	-webkit-line-clamp: 4;
	-webkit-box-orient: vertical;
}
</style>
<script>
	function showMoreContent(button) {
		// 버튼의 data-target 속성으로부터 대상 요소의 ID를 얻습니다.
		var contentId = button.getAttribute('data-target');
		// 해당 ID를 사용하여 내용 요소를 찾습니다.
		var contentElement = document.getElementById(contentId);
		// 내용 요소의 스타일을 변경하여 -webkit 관련 스타일을 제거합니다.
		contentElement.style.display = 'block';
		contentElement.style.webkitLineClamp = 'unset';
		contentElement.style.webkitBoxOrient = 'unset';
		// 더보기 버튼을 숨깁니다.
		button.style.display = 'none';
	}
</script>
</head>

<body>
	<main class="container-fluid">
		<div class="row">
			<nav class="col-2 bg-white sticky-top vh-100">
				<div th:insert="layout/nav.html :: nav"></div>
			</nav>

			<div class="justify-content-center col-9 container">
				<div th:if="${user != null}">
					<input type="hidden" th:value="${user.user_idx}" id="user_idx">
				</div>
				<div
					class="container-fluid d-flex justify-content-center align-items-center">
					<div class="row">
						<div class="col-md-8">
							<div th:each="item, iterStat : ${posts}" class="border mt-5"
								style="width: 470px; height: auto;">
								<div class="p-4">
									<!-- 첫 번째 내용 블록 -->
									<div class="d-flex justify-content-between mb-3">
										<input type="text" th:value="${item.post_id}" disabled>
										<input class="text-end" type="text"
											th:value="${item.post_updated_date}" readonly disabled>
									</div>
									<div class="">
										<div th:each="file : ${item.fileList}"
											class="d-flex justify-content-center">
											<img th:src="${file.file_Path}" alt="게시글 이미지"
												class="post-image mb-3" style="width: 280px; height: auto;">
										</div>
										<div th:id="'content' + ${iterStat.index}"
											class="mt-3 content px-3">
											<p th:id="'content_text' + ${iterStat.index}"
												th:text="${item.post_contents}" class="content_text"></p>
											<button
												class="toggleButton btn btn-link text-dark text-decoration-none"
												th:data-target="'content_text' + ${iterStat.index}"
												onclick="showMoreContent(this)">더보기</button>

										</div>

									</div>
									<div class="ms-3 my-1">
										<span class="fw-bold like_btn"
											th:attr="data-post-idx=${item.post_idx}, data-post-id=${item.post_id}"> <svg
												class="w-6 h-6 text-gray-800 text-danger"
												aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
												width="24" height="24" fill="none" viewBox="0 0 24 24">
                      							<path stroke="currentColor"
													stroke-linecap="round" stroke-linejoin="round"
													stroke-width="2"
													d="M12.01 6.001C6.5 1 1 8 5.782 13.001L12.011 20l6.23-7C23 8 17.5 1 12.01 6.002Z" />
                    						</svg>
										</span>
										<input type="text" th:value="${item.post_likes}" th:id="'post_likes' + ${item.post_idx}">
									</div>
									<div class="container-fluid mt-3">댓글창</div>
									<div class="mt-3 row">
										<textarea class="form-control comment-box col"
											placeholder="댓글 달기..." style="border: none; height: 3rem"></textarea>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		
	</main>
	<script>
	$(document).ready(function() {
	    const user_idx = $('#user_idx').val(); // 현재 사용자 ID

	    function updateScrapButtons() {
	        $('.like_btn').each(function() {
	            const button = $(this);
	            const post_idx = button.data('post-idx');
	            const svg = button.find('svg'); // SVG 요소 선택

	            // 스크랩 상태 확인 요청
	            $.ajax({
	                url: `/CheckLike?post_idx=` + post_idx + '&user_idx=' + user_idx,
	                type: 'GET',
	                dataType: 'json',
	                success: function(isLiked) {
	                    button.data('liked', isLiked);
	                    // isLiked 상태에 따라 SVG fill 속성 변경
	                    if (isLiked) {
	                        svg.attr('fill', 'red'); // 스크랩된 상태
	                    } else {
	                        svg.attr('fill', 'none'); // 스크랩되지 않은 상태
	                    }
	                    
	                },
	                error: function(error) {
	                    console.error('Error:', error);
	                }
	            });
	        });
	    }
	    updateScrapButtons();
	    
	    $('.like_btn').click(function() {
	        const button = $(this);
	        const post_idx = button.data('post-idx');
	        const isLiked = button.data('liked');

	        if (isLiked) {
	            // 스크랩 삭제 요청
	        	$.ajax({
	        	    url: '/LikeDelete', // URL 수정
	        	    type: 'DELETE',
	                contentType: 'application/json',
	                data: JSON.stringify({
	                    post_idx: post_idx,
	                    user_idx: user_idx
	                }),
	        	    success: function(response) {
	        	        updateScrapButtons(); // 모든 스크랩 버튼 상태 갱신
	        	        $.ajax({
	        	            url: '/LoadLikes',
	        	            type: 'POST',
	        	            data: { "post_idx": post_idx, "user_idx": user_idx },
	        	            success: function(loadlikes) {
	        	                $('#post_likes' + post_idx).val(loadlikes);
	        	            },
	        	            error: function() {
	        	                alert('오류가 발생했습니다. 다시 시도해주세요.');
	        	            }
	        	        });
	        	    },
	        	    error: function(error) {
	        	        console.error('Error:', error);
	        	        alert('오류가 발생했습니다. 다시 시도해주세요.');
	        	    }
	        	});

	        } else {
	            // 스크랩 추가 요청
	            $.ajax({
	                url: '/LikeAdd',
	                type: 'POST',
	                contentType: 'application/json',
	                data: JSON.stringify({
	                    post_idx: post_idx,
	                    user_idx: user_idx
	                }),
	                success: function(response) {
	                    updateScrapButtons(); // 모든 스크랩 버튼 상태 갱신
	        	        $.ajax({
	        	            url: '/LoadLikes',
	        	            type: 'POST',
	        	            data: { "post_idx": post_idx, "user_idx": user_idx },
	        	            success: function(loadlikes) {
	        	                $('#post_likes' + post_idx).val(loadlikes);
	        	            },
	        	            error: function() {
	        	                alert('오류가 발생했습니다. 다시 시도해주세요.');
	        	            }
	        	        });
	                },
	                error: function(error) {
	                    console.error('Error:', error);
	                    alert('오류가 발생했습니다. 다시 시도해주세요.');
	                }
	            });
	        }

	    });
	    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
	    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
	        return new bootstrap.Popover(popoverTriggerEl, {
	            trigger: 'focus'
	        });
	    });

	    // 팝 오버 내부 클릭 시 팝 오버가 닫히지 않도록 처리
	    document.body.addEventListener('click', function (e) {
	        var target = e.target;
	        var popover = document.querySelector('.popover');
	        if (popover && popover.contains(target)) {
	            e.stopPropagation(); // 팝 오버 내부 클릭 이벤트가 버블링되지 않도록 함
	        }
	    }, true); // 캡처 단계에서 이벤트를 처리하여, 이벤트가 버블링 단계로 넘어가기 전에 캡처함

	});
	</script>
	<script src="/js/youtubeLink.js"></script>
</body>

</html>