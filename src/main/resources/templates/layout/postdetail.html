<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>Insert title here</title>
</head>

<body>
	<div th:fragment="postdetail">
		<div class="modal fade" th:id="'postDetail' + ${notification_idx}" data-bs-backdrop="true"
			data-bs-keyboard="false" tabindex="-1" th:attr="aria-labelledby='postModalTitle' + ${notification_idx}"
			aria-hidden="true">
			<div th:if="${user != null}">
							<input type="hidden" th:value="${user.user_idx}" id="user_idx">
							<input type="hidden" th:value="${user.user_id}" id="user_id">
						</div>
			<div class="modal-dialog modal-xl modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-body">
						<h2 class="modal-title" th:id="'postModalTitle' + ${notification_idx}" th:text="${post.post_title}"></h2>
						<hr>
						<div th:if="${post != null}">
							<div class="d-flex justify-content-between mb-3">
								<input type="text" th:value="${post.post_id}" disabled>
								<input class="text-end" type="text" th:value="${post.post_updated_date}" readonly
									disabled>
							</div>
							<div class="">
								<div th:each="file : ${post.fileList}" class="d-flex justify-content-center">
									<img th:src="${file.file_Path}" alt="게시글 이미지" class="post-image mb-3"
										style="width: 280px; height: auto;">
								</div>
								<div th:id="'content' + ${post.post_id}" class="mt-3 px-3">
									<p th:id="'dcontent_text' + ${post.post_id}" data-postdetail-id=${post.post_id} th:text="${post.post_contents}"
										class="content_text content"></p>
									<button class="toggleButton btn btn-link text-dark text-decoration-none"
										th:data-target="'content_text' + ${post.post_id}"
										onclick="showMoreContent(this)">더보기</button>

								</div>

							</div>
							<div class="ms-3 my-1">
								<span class="fw-bold dlike_btn"
									th:attr="data-postdetail-idx=${post.post_idx}, data-postdetail-id=${post.post_id}, data-message-number=1"> <svg
										class="w-6 h-6 text-gray-800 text-danger" aria-hidden="true"
										xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none"
										viewBox="0 0 24 24">
										<path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
											stroke-width="2"
											d="M12.01 6.001C6.5 1 1 8 5.782 13.001L12.011 20l6.23-7C23 8 17.5 1 12.01 6.002Z" />
									</svg>
								</span>
								<input type="text" th:value="${post.post_likes}"
									th:id="'postdetail_likes' + ${post.post_idx}">
							</div>
							<div class="container-fluid mt-3">댓글창</div>
							<div class="mt-3 row">
								<textarea class="form-control comment-box col" placeholder="댓글 달기..."
									style="border: none; height: 3rem"></textarea>
							</div>
						</div>
						<div th:unless="${post != null}">
							<input type="text" value="글 못 읽음">
						</div>
					</div>
				</div>
			</div>
		</div>
		<script>
			$(document).ready(function() {
				    const user_idx = $('#user_idx').val(); // 현재 사용자 ID
				    const user_id = $('#user_id').val(); // 현재 사용자 ID
				    const to_id = $('#user_id').val(); // 현재 사용자 ID
				    const message = button.data('message-number');
			
				    function updateDetailLike() {
				        $('.dlike_btn').each(function() {
				            const button = $(this);
				            const post_idx = button.data('postdetail-idx');
				            const svg = button.find('svg'); // SVG 요소 선택
			
				            $.ajax({
				                url: `/CheckLike?post_idx=` + post_idx + '&user_idx=' + user_idx,
				                type: 'GET',
				                dataType: 'json',
				                success: function(isLiked) {
				                    button.data('liked', isLiked);
				                    // isLiked 상태에 따라 SVG fill 속성 변경
				                    if (isLiked) {
				                        svg.attr('fill', 'red'); 
				                    } else {
				                        svg.attr('fill', 'none'); 
				                    }
				                    
				                },
				                error: function(error) {
				                    console.error('Error:', error);
				                }
				            });
				        });
				    }
				    
					updateDetailLike();
				    
				    $('.dlike_btn').click(function() {
				        const button = $(this);
				        const post_idx = button.data('postdetail-idx');
				        const post_id = button.data('postdetail-id');
				        const isLiked = button.data('liked');
			
				        if (isLiked) {
			
				        	$.ajax({
				        	    url: '/LikeDelete', 
				        	    type: 'DELETE',
				                contentType: 'application/json',
				                data: JSON.stringify({
				                    post_idx: post_idx,
				                    user_idx: user_idx
				                }),
				        	    success: function(response) {
									updateDetailLike(); 
				        	        $.ajax({
				        	            url: '/LoadLikes',
				        	            type: 'POST',
				        	            data: { "post_idx": post_idx, "user_idx": user_idx },
				        	            success: function(loadlikes) {
				        	                $('#postdetail_likes' + post_idx).val(loadlikes);
				        	            },
				        	            error: function() {
				        	                alert('오류가 발생했습니다. 다시 시도해주세요.');
				        	            }
				        	        });
				        	    },
				        	    error: function(error) {
				        	        console.error('Error:', error);
				        	        alert('오류가 발생했습니다. 다시 시도해주세요.');
				        	    }
				        	});
			
				        } else {
			
				            $.ajax({
				                url: '/LikeAdd',
				                type: 'POST',
				                contentType: 'application/json',
				                data: JSON.stringify({
				                    post_idx: post_idx,
				                    user_idx: user_idx
				                }),
				                success: function(response) {
									updateDetailLike(); 
				        	        $.ajax({
				        	            url: '/LoadLikes',
				        	            type: 'POST',
				        	            data: { "post_idx": post_idx, "user_idx": user_idx },
				        	            success: function(loadlikes) {
				        	                $('#postdetail_likes' + post_idx).val(loadlikes);
				        	            },
				        	            error: function() {
				        	                alert('오류가 발생했습니다. 다시 시도해주세요.');
				        	            }
				        	        });
				        	        $.ajax({
				        	            url: '/AddNoti',
				        	            type: 'POST',
				        	            data: { "post_id": post_id, "user_id" : user_id, "post_idx": post_idx, "message" : message } ,
				        	            success: function(response) {
				        	                console.log('Add 성공');
				        	            },
				        	            error: function() {
				        	                alert('오류가 발생했습니다. 다시 시도해주세요.');
				        	            }
				        	        });
				                    
				                    
				                },
				                error: function(error) {
				                    console.error('Error:', error);
				                    alert('오류가 발생했습니다. 다시 시도해주세요.');
				                }
				            });
				        }
			
				    });
			
				});
		</script>
		<script>
			$(document).ready(function () {
			    // 모든 '#dcontent_text' 요소를 선택
			    $('.content_text').each(function () {
			        var htmlContent = $(this).html(); // 요소의 HTML 내용을 가져옴
			        const youtubeLinkPattern = /((?:.*?)(?:<br>|$))/g; // 모든 텍스트를 줄단위로 매칭합니다.
			
			        // 모든 줄을 순회하며 처리합니다.
			        htmlContent = htmlContent.split(youtubeLinkPattern).map(function (part) {
			            // 각 줄에 대해 유튜브 링크가 있는지 확인합니다.
			            if (/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)(?=[^\S]|$)/.test(part)) {
			                // 유튜브 링크를 포함하는 줄에 대해 처리합니다.
			                return part.replace(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)(?=[^\S]|$)/g, function (match, videoId) {
			                    // 유튜브 링크를 iframe으로 대체합니다.
			                    const iframe = `<iframe width="560" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
			                    return `<div class="row">${iframe}</div>`; // iframe을 row 클래스를 가진 div로 감쌉니다.
			                });
			            } else {
			                // 유튜브 링크가 없는 줄에 대해 처리합니다.
			                return `<div class="row">${part}</div>`; // 단순히 row 클래스를 가진 div로 감쌉니다.
			            }
			        }).join('');
			
			        // 수정된 내용으로 요소의 HTML을 업데이트합니다.
			        $(this).html(htmlContent);
			    });
			});

		</script>

	</div>

</body>

</html>